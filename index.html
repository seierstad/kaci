<!DOCTYPE html>
<html>
  <head>
    <title>JavaScript phase distortion synthesis</title>
    <style>
    	#envelope,
    	#waveform
    	{
    		border: 1px dotted green;
    	}
    	body {
    		background: orange;
    	}
    	#resonance-controller {
    		border: 1px dotted yellow;
    		background: rgba(255,255,255,0.2);
    	}
    	#pd-plot {
    		border: 1px dotted blue;
    		background: rgba(255,255,255,0.1);
    	}
    	.black {
    		fill: #000;
    	}
    	.white {
    		fill: #fff;
    		stroke: #000;
    	}
    </style>
  </head>
  <body>
  	<canvas height="500" width="500" id="waveform"></canvas>
  	<br />
	<div id="container"></div>
    <input type="range" size="4" id="freq" value="110"><label for="hz">Hz</label>

	 <script type="text/javascript" src="ControlledValue.js"></script>

    <script type="text/javascript">
    
		var resonantPhaseFactor = new ControlledValue(0.9);
		var frequency = new ControlledValue(0);
		frequency.afterUpdate = function() {
			phase_increment = this.value / sampleRate;
		};
      var currentSoundSample;
      var sampleRate = 44100;
		var phase = 0;
		var phase_increment = frequency.value / sampleRate;
      var points = [[0, 0], [1, 1]];
		var selectedPointIndex = null;

		var pointRadius = 10;
		var lineWidth = 1;

      var waveformCanvas = document.getElementById("waveform");
		var waveform = waveformCanvas.getContext("2d");

		function linearFunctionFromPoints(points) {
			var rate, constant;
			rate = (points[1][1] - points[0][1]) / (points[1][0] - points[0][0]);
			constant = points[0][1] - ( rate * points[0][0] );
			return {'rate': rate, 'constant': constant};
		}
      function limitZeroToOne(input) {
			if (input > 1) {
				return 1;
			} else if (input < 0){
				return 0;
			} else {
				return input;
			}
      }
		function phaseDistort(inputPhase) {
			var phase = limit(inputPhase);
			if (pdData.value.length > 1) {
				var line;
				for (var i = 1; i < pdData.value.length; i++) {
					if (phase >= pdData.value[i-1][0] && phase < pdData.value[i][0]) {
						line = linearFunctionFromPoints([pdData.value[i-1], pdData.value[i]]);
						return limitZeroToOne((phase * line.rate) + line.constant);
					}
				}
			} 
		}
		function limit(phase) {
			while (phase > 1) {
				phase -= 1;
			}
			while (phase < 0) {
				phase += 1;
			}
			return phase;
		}
		function sinus(phase) {
			return Math.sin(phase * Math.PI * 2);
		}
		function cosinus(phase) {
			return Math.cos(phase * Math.PI * 2);
		}
		
		function square(phase) {
			var limitedPhase = limit(phase);
			if (limitedPhase > 0.5) {
				return 1;
			} else {
				return -1;
			}
		}
		function anneMarie(phase) {
			var limitedPhase = limit(phase);
			if (limitedPhase < 0.5) {
				return limitedPhase * 2;
			} 
			if (limitedPhase >= 0.5) {
				return (limitedPhase-1) * 2;
			}
		}
		var baseWaveforms = {
			'sinus' : sinus,
			'cosinus' : cosinus,
			'square' : square,
			'Anne-Marie' : anneMarie
		};
		var constantWrapper = function(phase) {
			var constant = 1;
			return constant;
		};
		
		var linearWrapper = function(phase) {
			return 1-phase;
		};
		
		var halfSinusWrapper = function(phase) {
			return Math.sin(phase * Math.PI);
		};

		var wrapperFunctions = {
			'constant': constantWrapper,
			'linear': linearWrapper,
			'half_sinus': halfSinusWrapper
		};
		var baseWaveform = sinus;
		var wrapperFunction = wrapperFunctions.half_sinus;

		var resonantPhase = 0;

      function requestSoundData(soundData) {
        if (!frequency.value) { 
          return; // no sound selected
        }
        
        for (var i = 0, size = soundData.length; i < size; i++) {
//			 resonantPhaseFactor = envelope(noteOnTime, noteOffTime);
          soundData[i] = baseWaveform(phaseDistort(resonantPhase)) * wrapperFunction(phase);
        	 phase += phase_increment;
/*
        	 if (resonantPhaseFactor <= 0) {
        	 	resonantPhaseFactor = 0.00000001;
        	 }
*/
        	 resonantPhase += phase_increment / resonantPhaseFactor.value; 
        	 while (phase > 1) {
	        	phase -= 1;
	        	resonantPhase = 0;
			 }
        }        
      }

 var pdData = new ControlledValue([[0,0], [1,1]]);
     

  </script>
  <script type="text/javascript" src="waveformPlotter.js"></script>
  <script type="text/javascript" src="svgplot.js"></script>
  <script type="text/javascript" src="resonanceController.js"></script>
  <script type="text/javascript" src="keyboardController.js"></script>
  <script type="text/javascript" src="envelope.js"></script>
  <script type="text/javascript" src="audio.js"></script>
  </body>
</html>
